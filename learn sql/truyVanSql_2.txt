1. Top khách hàng:

- Khách hàng nào đã chi tiêu nhiều nhất trong năm 2024?

select full_name,
	sum(od.quantity * od.unit_price) as total
from orders o
join order_details od on o.order_id = od.order_id
join customers c on o.customer_id = c.customer_id
where o.status = "delivered" and year(o.order_date) = 2024
group by full_name
order by total desc
limit 1;

- Bao nhiêu khách hàng mua trên 10 đơn hàng?

select count(*) as so_khach_mua_tren_10_don
from (
	select count(distinct customer_id)
	from orders
	group by customer_id
	having count(*) > 10
    ) as bangdemsokhach;  



2. Sách bán chạy nhất:

- Cuốn sách nào được bán nhiều nhất (tổng số lượng)?

select title, sum(quantity) as ban_duoc
from books b
join order_details od
on b.book_id = od.book_id
group by b.book_id, title
order by ban_duoc desc
limit 1

- Tác giả nào có tổng doanh thu cao nhất?

select a.name, sum(od.quantity * od.unit_price) as doanh_thu
from authors a
join books b 
on b.author_id = a.author_id
join order_details od
on od.book_id = b.book_id
join orders o
on o.order_id = od.order_id
where o.status <> 'cancelled'
group by a.name
order by doanh_thu desc
limit 1

3. Đơn hàng phức tạp:

- Liệt kê các đơn hàng có tổng giá trị > 1 triệu.

select o.order_id, c.full_name, o.order_date, sum(od.quantity * od.unit_price) as gia_tri
from orders o
join customers c
on o.customer_id = c.customer_id
join order_details od
on od.order_id = o.order_id
group by o.order_id, c.full_name
having gia_tri > 1000000

- Tìm tất cả đơn hàng đã bị hủy, nhưng khách hàng đó trước đây có đơn hàng thành công.

select o.order_id, c.full_name, o.order_date
from orders o
join customers c
on o.customer_id = c.customer_id
where o.status = 'cancelled'
and exists (
	select c1.customer_id
	from customers c1
	join orders o1
	on c1.customer_id = o1.customer_id
	where o1.status = 'delivered'
	and o.customer_id = c1.customer_id
)
group by o.order_id, c.full_name



